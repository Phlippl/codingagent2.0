<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeContextAI Control Panel</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-online {
            background-color: #27ae60;
        }
        .status-offline {
            background-color: #e74c3c;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #2c3e50;
        }
        .action-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .action-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .action-button:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .action-button.danger {
            background-color: #e74c3c;
        }
        .action-button.danger:hover:not(:disabled) {
            background-color: #c0392b;
        }
        .action-button.success {
            background-color: #27ae60;
        }
        .action-button.success:hover:not(:disabled) {
            background-color: #219651;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .log-panel {
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin: 5px 0;
            line-height: 1.4;
        }
        .log-info {
            color: #3498db;
        }
        .log-success {
            color: #2ecc71;
        }
        .log-error {
            color: #e74c3c;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CodeContextAI Controller</h1>
        <div class="status-badge status-offline" id="agent-status">Offline</div>
    </div>

    <div class="card">
        <h2>Agent Steuerung</h2>
        <div class="button-group">
            <button id="start-agent" class="action-button success">Agent starten</button>
            <button id="stop-agent" class="action-button danger" disabled>Agent stoppen</button>
        </div>
        
        <div class="log-panel" id="log-panel">
            <div class="log-entry">Bereit. Starten Sie den Agenten, um zu beginnen.</div>
        </div>
    </div>

    <div class="card">
        <h2>Ngrok Tunnel</h2>
        <div id="tunnel-info">
            <p>Kein aktiver Tunnel vorhanden.</p>
        </div>
        <div class="button-group">
            <button id="start-tunnel" class="action-button success" disabled>Tunnel starten</button>
            <button id="stop-tunnel" class="action-button danger" disabled>Tunnel stoppen</button>
        </div>
    </div>

    <div class="card">
        <h2>Synchronisation</h2>
        <p>Synchronisieren Sie das Projektverzeichnis mit dem Index.</p>
        <div class="button-group">
            <button id="sync-project" class="action-button" disabled>Jetzt synchronisieren</button>
            <button id="rebuild-index" class="action-button danger" disabled>Index neu aufbauen</button>
        </div>
    </div>

    <script>
        // Status-Variablen
        let agentRunning = false;
        let tunnelRunning = false;
        let agentProcess = null;
        let tunnelProcess = null;
        
        // Elemente
        const agentStatusBadge = document.getElementById('agent-status');
        const startAgentBtn = document.getElementById('start-agent');
        const stopAgentBtn = document.getElementById('stop-agent');
        const logPanel = document.getElementById('log-panel');
        
        const startTunnelBtn = document.getElementById('start-tunnel');
        const stopTunnelBtn = document.getElementById('stop-tunnel');
        const tunnelInfo = document.getElementById('tunnel-info');
        
        const syncProjectBtn = document.getElementById('sync-project');
        const rebuildIndexBtn = document.getElementById('rebuild-index');
        
        // API URL
        const API_URL = 'http://localhost:8000';
        
        // Helper
        function logMessage(message, type = 'normal') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        function updateAgentStatus(running) {
            agentRunning = running;
            
            if (running) {
                agentStatusBadge.textContent = 'Online';
                agentStatusBadge.className = 'status-badge status-online';
                startAgentBtn.disabled = true;
                stopAgentBtn.disabled = false;
                startTunnelBtn.disabled = false;
                syncProjectBtn.disabled = false;
                rebuildIndexBtn.disabled = false;
            } else {
                agentStatusBadge.textContent = 'Offline';
                agentStatusBadge.className = 'status-badge status-offline';
                startAgentBtn.disabled = false;
                stopAgentBtn.disabled = true;
                startTunnelBtn.disabled = true;
                stopTunnelBtn.disabled = true;
                syncProjectBtn.disabled = true;
                rebuildIndexBtn.disabled = true;
            }
        }
        
        function updateTunnelStatus(running, url = '') {
            tunnelRunning = running;
            
            if (running && url) {
                startTunnelBtn.disabled = true;
                stopTunnelBtn.disabled = false;
                tunnelInfo.innerHTML = `
                    <p>Aktiver Tunnel:</p>
                    <div style="background: #f1f1f1; padding: 10px; border-radius: 4px; font-family: monospace;">
                        <a href="${url}" target="_blank">${url}</a>
                    </div>
                `;
            } else {
                startTunnelBtn.disabled = !agentRunning;
                stopTunnelBtn.disabled = true;
                tunnelInfo.innerHTML = '<p>Kein aktiver Tunnel vorhanden.</p>';
            }
        }
        
        // API Funktionen
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_URL}/`);
                
                if (response.ok) {
                    updateAgentStatus(true);
                    return true;
                } else {
                    updateAgentStatus(false);
                    return false;
                }
            } catch (error) {
                updateAgentStatus(false);
                return false;
            }
        }
        
        // Event Listeners
        startAgentBtn.addEventListener('click', async function() {
            logMessage('Starte CodeContextAI Agent...', 'info');
            
            try {
                // Starte den Agenten mit Python-Funktion
                agentProcess = await pywebview.api.startProcess('uvicorn', ['main:app', '--host', '0.0.0.0', '--port', '8000']);
                
                // Warte kurz und pr√ºfe den Status
                setTimeout(async function() {
                    const isRunning = await checkApiStatus();
                    
                    if (isRunning) {
                        logMessage('Agent erfolgreich gestartet!', 'success');
                    } else {
                        logMessage('Agent konnte nicht gestartet werden.', 'error');
                    }
                }, 3000);
                
            } catch (error) {
                logMessage(`Fehler beim Starten des Agenten: ${error}`, 'error');
                updateAgentStatus(false);
            }
        });
        
        stopAgentBtn.addEventListener('click', async function() {
            logMessage('Stoppe CodeContextAI Agent...', 'info');
            
            try {
                if (tunnelRunning) {
                    await pywebview.api.killProcess('ngrok');
                    updateTunnelStatus(false);
                }
                
                if (agentProcess) {
                    await pywebview.api.stopProcess(agentProcess);
                    agentProcess = null;
                } else {
                    await pywebview.api.killProcess('uvicorn');
                }
                
                updateAgentStatus(false);
                logMessage('Agent gestoppt.', 'success');
            } catch (error) {
                logMessage(`Fehler beim Stoppen des Agenten: ${error}`, 'error');
            }
        });
        
        startTunnelBtn.addEventListener('click', async function() {
            logMessage('Starte ngrok Tunnel...', 'info');
            
            try {
                tunnelProcess = await pywebview.api.startProcess('ngrok', ['http', '8000']);
                
                // Warte kurz, dann hole die Tunnel-URL
                setTimeout(async function() {
                    try {
                        const response = await fetch('http://localhost:4040/api/tunnels');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.tunnels && data.tunnels.length > 0) {
                                const httpsUrl = data.tunnels.find(tunnel => 
                                    tunnel.public_url.startsWith('https://')
                                )?.public_url;
                                
                                if (httpsUrl) {
                                    updateTunnelStatus(true, httpsUrl);
                                    logMessage(`Tunnel erfolgreich erstellt: ${httpsUrl}`, 'success');
                                } else {
                                    logMessage('Keine HTTPS-URL im Tunnel gefunden.', 'error');
                                    updateTunnelStatus(false);
                                }
                            } else {
                                logMessage('Keine Tunnel gefunden.', 'error');
                                updateTunnelStatus(false);
                            }
                        } else {
                            logMessage('Konnte Tunnel-Informationen nicht abrufen.', 'error');
                            updateTunnelStatus(false);
                        }
                    } catch (error) {
                        logMessage('Fehler beim Abrufen der Tunnel-URL.', 'error');
                        updateTunnelStatus(true, 'Tunnel l√§uft, URL konnte nicht ermittelt werden');
                    }
                }, 2000);
                
            } catch (error) {
                logMessage(`Fehler beim Starten des Tunnels: ${error}`, 'error');
                updateTunnelStatus(false);
            }
        });
        
        stopTunnelBtn.addEventListener('click', async function() {
            logMessage('Stoppe ngrok Tunnel...', 'info');
            
            try {
                if (tunnelProcess) {
                    await pywebview.api.stopProcess(tunnelProcess);
                    tunnelProcess = null;
                } else {
                    await pywebview.api.killProcess('ngrok');
                }
                
                updateTunnelStatus(false);
                logMessage('Tunnel gestoppt.', 'success');
            } catch (error) {
                logMessage(`Fehler beim Stoppen des Tunnels: ${error}`, 'error');
            }
        });
        
        syncProjectBtn.addEventListener('click', async function() {
            if (!agentRunning) return;
            
            logMessage('Starte Projektsynchronisation...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/sync?wait=true`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const changedFiles = data.changed_files || [];
                        logMessage(`Synchronisation abgeschlossen: ${changedFiles.length} Dateien ge√§ndert.`, 'success');
                    } else {
                        logMessage(`Synchronisation fehlgeschlagen: ${data.message}`, 'error');
                    }
                } else {
                    logMessage('Synchronisation fehlgeschlagen: API-Fehler', 'error');
                }
            } catch (error) {
                logMessage(`Fehler bei der Synchronisation: ${error}`, 'error');
            }
        });
        
        rebuildIndexBtn.addEventListener('click', async function() {
            if (!agentRunning) return;
            
            if (!confirm('Soll der Index wirklich komplett neu aufgebaut werden? Dies kann bei gro√üen Projekten einige Zeit dauern.')) {
                return;
            }
            
            logMessage('Starte kompletten Neuaufbau des Index...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/rebuild?wait=true`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force_rebuild: true
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        logMessage(`Index-Neuaufbau abgeschlossen: ${data.chunks_processed || 0} Chunks verarbeitet.`, 'success');
                    } else {
                        logMessage(`Index-Neuaufbau fehlgeschlagen: ${data.message}`, 'error');
                    }
                } else {
                    logMessage('Index-Neuaufbau fehlgeschlagen: API-Fehler', 'error');
                }
            } catch (error) {
                logMessage(`Fehler beim Index-Neuaufbau: ${error}`, 'error');
            }
        });
        
        // Initialisierung
        async function initialize() {
            logMessage('Pr√ºfe API-Status...', 'info');
            const isRunning = await checkApiStatus();
            
            if (isRunning) {
                logMessage('Agent bereits gestartet.', 'success');
                
                // Pr√ºfe, ob ein Tunnel l√§uft
                try {
                    const response = await fetch('http://localhost:4040/api/tunnels');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.tunnels && data.tunnels.length > 0) {
                            const httpsUrl = data.tunnels.find(tunnel => 
                                tunnel.public_url.startsWith('https://')
                            )?.public_url;
                            
                            if (httpsUrl) {
                                updateTunnelStatus(true, httpsUrl);
                                logMessage(`Aktiver Tunnel gefunden: ${httpsUrl}`, 'success');
                            }
                        }
                    }
                } catch (error) {
                    // Kein Tunnel aktiv, ignorieren
                }
            } else {
                logMessage('Agent ist nicht gestartet. Verwenden Sie den "Agent starten" Button.', 'info');
            }
        }
        
        // F√ºhre Initialisierung aus, wenn DOM geladen ist
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Pr√ºfe regelm√§√üig den Status
        setInterval(checkApiStatus, 5000);
        
        // Log, dass das UI geladen wurde
        logMessage('UI geladen und bereit.', 'info');
    </script>
</body>
</html>